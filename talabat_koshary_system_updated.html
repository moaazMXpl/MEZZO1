<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Talabat â€” Koshary (Ù†Ø¸Ø§Ù… ÙƒØ§Ù…Ù„)</title>
<style>
:root{
  --bg:#0f172a; --card:#0b1220; --muted:#94a3b8; --accent:#ff6b35; --gold:#ffd700; --success:#16a34a;
  --light-bg:#f8fafc; --light-card:#fff; --light-text:#0f172a;
}
html,body{height:100%;margin:0;padding:0;font-family:Tahoma, Arial, sans-serif;background:var(--bg);color:#e6eef8}
body.light{background:linear-gradient(180deg,#fff,#f3f4f6);color:var(--light-text)}
.container{max-width:1200px;margin:18px auto;padding:18px;display:grid;grid-template-columns:1fr;gap:18px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px}
.brand{display:flex;flex-direction:column}
.brand h1{margin:0;font-size:1.6rem;letter-spacing:0.4px}
.brand p{margin:0;color:var(--muted);font-size:0.9rem}
.controls{display:flex;gap:8px;align-items:center}
.btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
.btn.secondary{background:#374151;color:#fff}
.switch{display:flex;align-items:center;gap:8px;background:transparent;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,215,0,0.06)}
.light .card{background:var(--light-card);box-shadow:none;border:1px solid rgba(0,0,0,0.06)}

/* layout */
.grid-2{display:grid;grid-template-columns:1fr 420px;gap:18px}
@media(max-width:980px){.grid-2{grid-template-columns:1fr}}

/* menu */
.menu-section{margin-bottom:12px}
.section-title{background:var(--gold);color:#1f2937;padding:10px;border-radius:8px;font-weight:bold;margin-bottom:10px;text-align:center}
.menu-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.menu-item{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.04);display:flex;flex-direction:column;gap:8px}
.menu-item h4{margin:0}
.price{color:var(--accent);font-weight:bold}
.controls-small{display:flex;gap:6px;align-items:center}
.qty-btn{width:30px;height:30px;border-radius:6px;border:0;background:rgba(255,255,255,0.03);color:#fff;cursor:pointer}
.add-cart{background:var(--success);color:#fff;padding:8px;border-radius:8px;border:0;cursor:pointer}

/* cart panel */
.cart-panel{position:sticky;top:18px;background:var(--card);padding:12px;border-radius:12px;border:1px solid rgba(255,215,0,0.04)}
.cart-title{font-weight:bold;margin-bottom:8px}
.cart-items{max-height:50vh;overflow:auto;margin-bottom:10px}
.cart-item{display:flex;justify-content:space-between;gap:10px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);margin-bottom:8px}

/* operator */
.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tab{padding:8px 12px;border-radius:10px;background:rgba(255,255,255,0.03);cursor:pointer}
.tab.active{background:var(--accent);color:#fff}
.orders-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.order-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;border:1px solid rgba(255,215,0,0.04)}

/* small helpers */
.input,textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
.light .input, .light textarea, .light select{border:1px solid rgba(0,0,0,0.08)}
.small{font-size:0.85rem;color:var(--muted)}
.kv{display:flex;gap:6px;align-items:center}
.badge{padding:4px 8px;border-radius:999px;background:var(--gold);color:#1f2937;font-weight:bold;font-size:0.85rem}
.notify{position:fixed;left:18px;bottom:18px;padding:10px;border-radius:10px;background:var(--success);color:#fff;display:none;z-index:9999}
.footer{font-size:0.85rem;color:var(--muted);text-align:center;margin-top:10px}
.light .badge{background:#ffd700;color:#1f2937}

/* offer badges */
.offer-badge{background:#064e3b;color:#fff;padding:4px 8px;border-radius:8px;font-weight:bold;font-size:0.85rem}
</style>
</head>
<body id="body">
<div class="container light-mode-available">

  <div class="header">
    <div class="brand">
      <h1>ğŸ› Talabat â€” Koshary</h1>
      <p class="small">Ù†Ø¸Ø§Ù… Ø·Ù„Ø¨Ø§Øª Ù…Ø­Ù„ÙŠ (Ø¹Ù…ÙŠÙ„ + Ù…Ø´ØºÙ„) â€” ÙƒÙ„ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ØªØ­ÙØ¸ Ù…Ø­Ù„ÙŠÙ‹Ø§</p>
    </div>

    <div class="controls">
      <label class="kv small">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†
        <input id="darkToggle" type="checkbox" style="margin-inline-start:8px">
      </label>

      <button class="btn secondary" id="switchCustomer">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
      <button class="btn" id="switchOperator">ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´ØºÙ„</button>
    </div>
  </div>

  <div id="mainCustomer" class="card">
    <!-- customer header/login -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:12px">
      <div>
        <strong>Ù…Ø±Ø­Ø¨Ø§ Ø¨Ø§Ù„Ø²Ø¨Ø§Ø¦Ù† â€” Ø³Ø¬Ù„ Ø¨Ø§Ø³Ù…Ùƒ ÙˆØ±Ù‚Ù…Ùƒ</strong>
        <div class="small">ØªØ³Ø¬ÙŠÙ„ ÙŠØ­ÙØ¸ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠØ©</div>
      </div>
      <div style="max-width:360px;min-width:220px">
        <div style="display:flex;gap:8px">
          <input id="custName" class="input" placeholder="Ø§Ø³Ù…Ùƒ" />
          <input id="custPhone" class="input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" />
          <button class="btn" id="saveCustomerBtn">Ø­ÙØ¸</button>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <!-- Menu sections will be injected here -->
        <div id="menuContainer"></div>
      </div>

      <aside class="cart-panel card" id="cartPanel">
        <div class="cart-title">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
        <div class="small" id="cartCustomerInfo">Ø¶ÙŠÙ â€” Ù„Ù… ØªØ³Ø¬Ù„ Ø¨Ø¹Ø¯</div>
        <div class="cart-items" id="cartItems"></div>
        <div style="display:flex;gap:6px;align-items:center;margin-bottom:8px">
          <div class="badge" id="cartTotal">0 Ø¬</div>
          <div class="small" style="flex:1">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
        </div>

        <div style="margin-bottom:8px">
          <label class="small">Ø§Ø®ØªØ± Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <select id="applyOffer" class="input"></select>
        </div>

        <div style="display:flex;gap:8px">
          <button class="add-cart" id="checkoutBtn" style="flex:1">Ø§ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</button>
          <button class="btn secondary" id="clearCartBtn" style="padding-inline:10px">ØªÙØ±ÙŠØº</button>
        </div>

        <div style="margin-top:10px;font-size:0.9rem;color:var(--muted)">
          Ø§Ù„Ø¯ÙØ¹ Ù†Ù‚Ø¯Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ â€” ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø©/ÙÙˆØ±ÙŠ Ù„Ø§Ø­Ù‚Ù‹Ø§
        </div>
      </aside>
    </div>

    <!-- checkout modal replacement section -->
    <div id="checkoutSection" class="card" style="margin-top:12px;display:none">
      <div class="section-title">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ & Ø§Ù„Ø¯ÙØ¹</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <input id="orderName" class="input" placeholder="Ø§Ù„Ø§Ø³Ù…" />
        <input id="orderPhone" class="input" placeholder="Ø§Ù„Ù‡Ø§ØªÙ" />
        <input id="orderAddress" class="input" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (ØªÙØµÙŠÙ„)" style="grid-column:1/3"/>
        <select id="orderPayment" class="input">
          <option value="cash">Ù†Ù‚Ø¯Ù‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</option>
          <option value="vodafone">ØªØ­ÙˆÙŠÙ„ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´</option>
          <option value="card">Ø¨Ø·Ø§Ù‚Ø© (ØºÙŠØ± Ù…ÙØ¹Ù„)</option>
          <option value="fawry">ÙÙˆØ±ÙŠ (ØºÙŠØ± Ù…ÙØ¹Ù„)</option>
        </select>
        <textarea id="orderNotes" class="input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="grid-column:1/3"></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="add-cart" id="confirmOrderBtn" style="flex:1">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</button>
        <button class="btn secondary" id="cancelCheckoutBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Operator area -->
  <div id="mainOperator" class="card" style="display:none">
    <div id="operatorLoginPanel">
      <div style="display:flex;gap:8px;align-items:center">
        <div style="flex:1">
          <div class="small">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØºÙ„</div>
          <input id="operatorPasswordInput" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="btn" id="operatorLoginBtn">Ø¯Ø®ÙˆÙ„</button>
          <button class="btn secondary" id="showPwdBtn">Ø¹Ø±Ø¶ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
        </div>
      </div>
    </div>

    <div id="operatorDashboard" style="display:none;margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="kv">
            <div class="badge">Operator</div>
            <div class="small" style="margin-inline-start:8px" id="operatorHint">Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
          </div>
        </div>

        <div style="display:flex;gap:8px">
          <button class="btn secondary" id="operatorLogoutBtn">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
          <button class="btn" id="exportDataBtn">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <div class="tabs" id="opTabs">
          <div class="tab active" data-tab="ordersTab">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
          <div class="tab" data-tab="menuTab">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
          <div class="tab" data-tab="reportsTab">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
          <div class="tab" data-tab="offersTab">Ø§Ù„Ø¹Ø±ÙˆØ¶</div>
        </div>

        <div id="ordersTab" class="tabContent">
          <div class="section-title">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</div>
          <div class="orders-grid" id="ordersGrid"></div>
        </div>

        <div id="menuTab" class="tabContent" style="display:none">
          <div class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:320px">
              <h4 class="small">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</h4>
              <div id="manageMenuList" style="display:grid;gap:8px;margin-top:8px"></div>
            </div>
            <div style="width:320px">
              <h4 class="small">Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h4>
              <div style="display:grid;gap:8px">
                <input id="newName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù" />
                <input id="newPrice" class="input" placeholder="Ø§Ù„Ø³Ø¹Ø±" type="number" />
                <select id="newCategory" class="input"></select>
                <button class="btn" id="addNewItemBtn">Ø¥Ø¶Ø§ÙØ©</button>
              </div>
            </div>
          </div>
        </div>

        <div id="reportsTab" class="tabContent" style="display:none">
          <div class="section-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:12px">
            <div class="card small"><div class="small">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div><div id="rToday" style="font-weight:bold;font-size:1.4rem">0</div></div>
            <div class="card small"><div class="small">Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ… (Ø¬)</div><div id="rRevenue" style="font-weight:bold;font-size:1.4rem">0</div></div>
            <div class="card small"><div class="small">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div><div id="rTotal" style="font-weight:bold;font-size:1.4rem">0</div></div>
            <div class="card small"><div class="small">Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ù‹Ø§</div><div id="rTop" style="font-weight:bold;font-size:1.4rem">-</div></div>
          </div>
          <div id="popularList"></div>
        </div>

        <div id="offersTab" class="tabContent" style="display:none">
          <div class="section-title">Ø§Ù„Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù†Ø´Ø·Ø©</div>
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:320px">
              <div id="activeOffersList"></div>
            </div>
            <div style="width:320px">
              <h4 class="small">Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</h4>
              <input id="offerName" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¶" />
              <input id="offerDiscount" class="input" placeholder="Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ… (%)" type="number" min="0" max="100" />
              <button class="btn" id="createOfferBtn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="card">
          <h4 class="small">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´ØºÙ„</h4>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <input id="newOperatorPassword" class="input" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø¶ØºØ· Ø­ÙØ¸)" />
            <button class="btn" id="saveOperatorPwd">Ø­ÙØ¸</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="notify" class="notify"></div>
  <div class="footer small">Ù‡Ø°Ø§ Ù…Ù„Ù Ù…Ø³ØªÙ‚Ù„. ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ù…ØªØµÙØ­Ùƒ. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„Ù‡ ÙˆØªØ´ØºÙŠÙ„Ù‡ Ù…Ø­Ù„ÙŠÙ‹Ø§.</div>
</div>

<script>
// --- Utilities and storage helpers ---
const LS_KEYS = {
  MENU: 'tk_menu_v1',
  ORDERS: 'tk_orders_v1',
  OFFERS: 'tk_offers_v1',
  OP_PWD: 'tk_op_pwd_v1',
  CUST: 'tk_cust_v1',
  ORDER_COUNTER:'tk_order_counter_v1'
};

function saveLS(key, data){ localStorage.setItem(key, JSON.stringify(data)); }
function loadLS(key, fallback){ try{ const r = localStorage.getItem(key); return r ? JSON.parse(r) : fallback; }catch(e){return fallback;} }
function generateId(prefix='ID'){ return prefix + '-' + Date.now().toString(36) + '-' + Math.floor(Math.random()*900).toString(36); }

// --- Default data (from your menu) ---
const DEFAULT_MENU = {
  "Ø§Ù„ÙƒØ´Ø±ÙŠ": [
    {id:'k-mini', name:'Ø¹Ù„Ø¨Ø© Ù…ÙŠÙ†ÙŠ', price:17, available:true, sold:0},
    {id:'k-large', name:'Ø¹Ù„Ø¨Ø© Ù„Ø§Ø±Ø¬', price:20, available:true, sold:0},
    {id:'k-shaqia', name:'Ø¹Ù„Ø¨Ø© Ø´Ù‚ÙŠØ©', price:25, available:true, sold:0},
    {id:'k-mftria', name:'Ø¹Ù„Ø¨Ù‡ Ù…ÙØªØ±ÙŠØ©', price:30, available:true, sold:0},
    {id:'k-abo', name:'Ø¹Ù„Ø¨Ø© Ø£Ø¨Ùˆ Ø³Ù…Ø±Ø©', price:35, available:true, sold:0},
    {id:'k-triple', name:'Ø¹Ù„Ø¨Ø© ØªØ±ÙŠØ¨Ù„', price:40, available:true, sold:0}
  ],
  "Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„ÙƒØ´Ø±ÙŠ":[
    {id:'add-tqliya',name:'ØªÙ‚Ù„ÙŠÙ‡',price:9,available:true,sold:0},
    {id:'add-salsa',name:'ØµÙ„ØµØ©',price:6,available:true,sold:0},
    {id:'add-dokka',name:'Ø¯Ù‚Ø©',price:4,available:true,sold:0},
    {id:'add-shata',name:'Ø´Ø·Ø©',price:4,available:true,sold:0},
    {id:'add-ads',name:'Ø¹Ø¯Ø³',price:6,available:true,sold:0}
  ],
  "Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©":[
    {id:'side-qaramisho',name:'Ù‚Ø±Ø§Ù…ÙŠØ´Ùˆ (ØªÙˆØ³Øª)',price:9,available:true,sold:0},
    {id:'side-mkhlal',name:'Ù…Ø®Ù„Ù„ Ù…Ø´ÙƒÙ„',price:8,available:true,sold:0},
    {id:'side-slt-kh',name:'Ø³Ù„Ø·Ø© Ø®Ø¶Ø±Ø§Ø¡',price:8,available:true,sold:0},
    {id:'side-khyar',name:'Ø®ÙŠØ§Ø± Ù…ØªØ¨Ù„',price:8,available:true,sold:0},
    {id:'side-tmatem',name:'Ø·Ù…Ø§Ø·Ù… Ù…ØªØ¨Ù„Ù‡',price:8,available:true,sold:0}
  ],
  "Ø§Ù„Ø·ÙˆØ§Ø¬Ù†":[
    {id:'t-mkr',name:'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø³Ø§Ø¯Ø©',price:27,available:true,sold:0},
    {id:'t-mkr-lhm',name:'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„Ù„Ø­Ù…Ø©',price:45,available:true,sold:0},
    {id:'t-mkr-dj',name:'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ø§Ù„Ø¯Ø¬Ø§Ø¬',price:47,available:true,sold:0}
  ],
  "Ø·ÙˆØ§Ø¬Ù† Ù…ÙŠÙƒØ³":[
    {id:'mix-sada',name:'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø³Ø§Ø¯Ø©',price:47,available:true,sold:0},
    {id:'mix-lhm',name:'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø¨Ø§Ù„Ù„Ø­Ù…Ø©',price:65,available:true,sold:0},
    {id:'mix-dj',name:'Ø·Ø§Ø¬Ù† Ù…ÙŠÙƒØ³ Ø¨Ø§Ù„Ø¯Ø¬Ø§Ø¬',price:65,available:true,sold:0}
  ],
  "Ø·ÙˆØ§Ø¬Ù† Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§":[
    {id:'moz-sada',name:'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø³Ø§Ø¯Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§',price:47,available:true,sold:0},
    {id:'moz-lhm',name:'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ù„Ø­Ù…Ø© Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§',price:65,available:true,sold:0},
    {id:'moz-dj',name:'Ø·Ø§Ø¬Ù† Ù…ÙƒØ±ÙˆÙ†Ø© Ø¨Ù„Ø¯Ø¬Ø§Ø¬ Ù…ÙˆØ²Ø§Ø±ÙŠÙ„Ø§',price:65,available:true,sold:0}
  ],
  "Ø­Ù„Ùˆ Ø£Ø¨ÙˆØ³Ù…Ø±Ø©":[
    {id:'hlb-kebir',name:'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† ÙƒØ¨ÙŠØ±',price:18,available:true,sold:0},
    {id:'hlb-forn',name:'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† ÙØ±Ù†',price:20,available:true,sold:0},
    {id:'hlb-koshry',name:'ÙƒØ´Ø±ÙŠ Ø§Ù„Ø­Ù„Ùˆ',price:22,available:true,sold:0},
    {id:'hlb-qar3',name:'Ø£Ø±Ø² Ø¨Ø§Ù„Ù„Ø¨Ù† Ø¨Ø§Ù„Ù‚Ø±Ø¹',price:25,available:true,sold:0}
  ],
  "Ù…Ø´Ø±ÙˆØ¨Ø§Øª":[
    {id:'water-s',name:'Ù…ÙŠØ§Ù‡ ØµØºÙŠØ±Ø©',price:6,available:true,sold:0},
    {id:'water-l',name:'Ù…ÙŠØ§Ù‡ ÙƒØ¨ÙŠØ±Ø©',price:10,available:true,sold:0},
    {id:'pepsi',name:'Ø¨Ø¨ÙŠØ¬ ÙƒÙˆÙ„Ø§',price:18,available:true,sold:0},
    {id:'slsh-tot',name:'Ø¹ØµÙŠØ± Ø³Ù„Ø§Ø´ ØªÙˆØª',price:10,available:true,sold:0},
    {id:'slsh-lmna',name:'Ø¹ØµÙŠØ± Ø³Ù„Ø§Ø´ (Ù„ÙŠÙ…ÙˆÙ† â€“ Ù†Ø¹Ù†Ø§Ø¹)',price:18,available:true,sold:0}
  ]
};

// --- State ---
let menu = loadLS(LS_KEYS.MENU, DEFAULT_MENU);
let orders = loadLS(LS_KEYS.ORDERS, []);
let offers = loadLS(LS_KEYS.OFFERS, []);
let operatorPassword = localStorage.getItem(LS_KEYS.OP_PWD) || 'admin123';
let currentCustomer = loadLS(LS_KEYS.CUST, null);
let orderCounter = Number(localStorage.getItem(LS_KEYS.ORDER_COUNTER) || Date.now()%100000);

// --- DOM refs ---
const menuContainer = document.getElementById('menuContainer');
const cartItemsEl = document.getElementById('cartItems');
const cartTotalEl = document.getElementById('cartTotal');
const custNameInput = document.getElementById('custName');
const custPhoneInput = document.getElementById('custPhone');
const saveCustomerBtn = document.getElementById('saveCustomerBtn');
const cartCustomerInfo = document.getElementById('cartCustomerInfo');
const checkoutBtn = document.getElementById('checkoutBtn');
const checkoutSection = document.getElementById('checkoutSection');
const confirmOrderBtn = document.getElementById('confirmOrderBtn');
const cancelCheckoutBtn = document.getElementById('cancelCheckoutBtn');
const orderName = document.getElementById('orderName');
const orderPhone = document.getElementById('orderPhone');
const orderAddress = document.getElementById('orderAddress');
const orderPayment = document.getElementById('orderPayment');
const orderNotes = document.getElementById('orderNotes');
const applyOfferSelect = document.getElementById('applyOffer');

const mainCustomer = document.getElementById('mainCustomer');
const mainOperator = document.getElementById('mainOperator');
const switchCustomer = document.getElementById('switchCustomer');
const switchOperator = document.getElementById('switchOperator');
const darkToggle = document.getElementById('darkToggle');
const body = document.getElementById('body');

const operatorLoginBtn = document.getElementById('operatorLoginBtn');
const operatorPasswordInput = document.getElementById('operatorPasswordInput');
const operatorLoginPanel = document.getElementById('operatorLoginPanel');
const operatorDashboard = document.getElementById('operatorDashboard');
const operatorHint = document.getElementById('operatorHint');
const operatorLogoutBtn = document.getElementById('operatorLogoutBtn');
const exportDataBtn = document.getElementById('exportDataBtn');
const showPwdBtn = document.getElementById('showPwdBtn');

// op tabs
const opTabs = document.getElementById('opTabs');
const ordersGrid = document.getElementById('ordersGrid');
const manageMenuList = document.getElementById('manageMenuList');
const newName = document.getElementById('newName');
const newPrice = document.getElementById('newPrice');
const newCategory = document.getElementById('newCategory');
const addNewItemBtn = document.getElementById('addNewItemBtn');
const rToday = document.getElementById('rToday');
const rRevenue = document.getElementById('rRevenue');
const rTotal = document.getElementById('rTotal');
const rTop = document.getElementById('rTop');
const popularList = document.getElementById('popularList');
const activeOffersList = document.getElementById('activeOffersList');
const createOfferBtn = document.getElementById('createOfferBtn');
const offerName = document.getElementById('offerName');
const offerDiscount = document.getElementById('offerDiscount');
const exportDataButton = document.getElementById('exportDataBtn');
const newOperatorPassword = document.getElementById('newOperatorPassword');
const saveOperatorPwd = document.getElementById('saveOperatorPwd');

// cart runtime
let cart = [];

// --- Init ---
function init(){
  // apply theme
  const darkStored = localStorage.getItem('tk_dark_v1') === '1';
  darkToggle.checked = darkStored;
  applyTheme(darkStored);

  // customer
  if(currentCustomer){
    custNameInput.value = currentCustomer.name;
    custPhoneInput.value = currentCustomer.phone;
    cartCustomerInfo.textContent = `${currentCustomer.name} â€” ${currentCustomer.phone}`;
  }

  // render menu & offers
  renderMenu();
  renderApplyOffers();
  populateCategorySelect();
  renderManageMenu();

  // attach events
  switchCustomer.addEventListener('click', ()=>{ mainCustomer.style.display='block'; mainOperator.style.display='none' });
  switchOperator.addEventListener('click', ()=>{ mainCustomer.style.display='none'; mainOperator.style.display='block' });
  saveCustomerBtn.addEventListener('click', saveCustomer);
  checkoutBtn.addEventListener('click', openCheckout);
  cancelCheckoutBtn.addEventListener('click', ()=>checkoutSection.style.display='none');
  confirmOrderBtn.addEventListener('click', confirmOrder);

  operatorLoginBtn.addEventListener('click', operatorLogin);
  operatorLogoutBtn.addEventListener('click', operatorLogout);
  showPwdBtn.addEventListener('click', ()=>alert('ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: '+ operatorPassword));

  addNewItemBtn.addEventListener('click', addMenuItemFromForm);
  createOfferBtn.addEventListener('click', createOffer);

  exportDataBtn.addEventListener('click', exportAllData);

  darkToggle.addEventListener('change', ()=>{
    const isDark = darkToggle.checked;
    applyTheme(isDark);
    localStorage.setItem('tk_dark_v1', isDark?'1':'0');
  });

  // op tabs
  opTabs.addEventListener('click', (e)=>{
    if(e.target && e.target.dataset.tab){
      document.querySelectorAll('#opTabs .tab').forEach(t=>t.classList.remove('active'));
      e.target.classList.add('active');
      document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display='none');
      document.getElementById(e.target.dataset.tab).style.display='block';
      if(e.target.dataset.tab === 'ordersTab') renderOrders();
      if(e.target.dataset.tab === 'reportsTab') updateReports();
      if(e.target.dataset.tab === 'menuTab') renderManageMenu();
      if(e.target.dataset.tab === 'offersTab') renderOffers();
    }
  });

  // load initial sample order into operator view (if any) and persist
  saveState();
  renderOrders();
  updateReports();
}

// --- Theme ---
function applyTheme(isDark){
  if(!isDark){ body.classList.add('light'); } else { body.classList.remove('light'); }
}

// --- Menu rendering ---
function renderMenu(){
  // clear
  menuContainer.innerHTML = '';
  Object.keys(menu).forEach(cat => {
    const sec = document.createElement('div');
    sec.className = 'menu-section';
    sec.innerHTML = `<div class="section-title">${cat}</div><div class="menu-grid" id="grid-${cat}"></div>`;
    menuContainer.appendChild(sec);
    const grid = sec.querySelector('.menu-grid');
    menu[cat].forEach(item => {
      const card = document.createElement('div');
      card.className = 'menu-item';
      card.dataset.id = item.id;
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h4>${item.name}</h4>
          <div class="small">${item.available ? '' : '<span class="small" style="color:#f97316">ØºÙŠØ± Ù…ØªÙˆÙØ±</span>'}</div>
        </div>
        <div class="price">${item.price} Ø¬</div>
        <div class="controls-small">
          <button class="qty-btn" data-act="dec">-</button>
          <div style="min-width:28px;text-align:center" class="small qty">0</div>
          <button class="qty-btn" data-act="inc">+</button>
        </div>
        <div>
          <button class="add-cart" ${!item.available ? 'disabled' : ''}>Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      `;
      // events
      const inc = card.querySelector('[data-act="inc"]');
      const dec = card.querySelector('[data-act="dec"]');
      const qtyEl = card.querySelector('.qty');
      const addBtn = card.querySelector('button.add-cart');
      inc.addEventListener('click', ()=>{ qtyEl.textContent = Number(qtyEl.textContent)+1; });
      dec.addEventListener('click', ()=>{ if(Number(qtyEl.textContent)>0) qtyEl.textContent = Number(qtyEl.textContent)-1; });
      addBtn.addEventListener('click', ()=>{
        const qty = Number(qtyEl.textContent);
        if(qty<=0){ notify('Ø§Ø®ØªØ± Ø§Ù„ÙƒÙ…ÙŠØ© Ø£ÙˆÙ„Ø§','warning'); return; }
        addToCart(item.id, qty);
        qtyEl.textContent = '0';
      });
      grid.appendChild(card);
    });
  });
}

// --- Cart ---
function addToCart(itemId, qty){
  // find item
  const it = findItemById(itemId);
  if(!it || !it.available){ notify('Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ØªØ§Ø­','error'); return; }
  const existing = cart.find(c => c.id === it.id);
  if(existing){ existing.qty += qty; } else { cart.push({id:it.id, name:it.name, price:it.price, qty}); }
  updateCartDisplay();
  notify(`${it.name} ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ø³Ù„Ø©`,'success');
}

function updateCartDisplay(){
  cartItemsEl.innerHTML = '';
  if(cart.length===0){ cartItemsEl.innerHTML = '<div class="small" style="text-align:center;padding:8px;color:var(--muted)">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>'; cartTotalEl.textContent='0 Ø¬'; return; }
  let total = 0;
  cart.forEach((c, idx) => {
    const line = document.createElement('div');
    line.className = 'cart-item';
    const itemTotal = c.qty * c.price;
    total += itemTotal;
    line.innerHTML = `<div><strong>${c.name}</strong><div class="small">${c.qty} Ã— ${c.price} Ø¬</div></div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <div style="font-weight:bold">${itemTotal} Ø¬</div>
        <div style="display:flex;gap:6px">
          <button class="small" style="background:transparent;border:0;color:var(--muted);cursor:pointer" onclick="cartDecrease(${idx})">-</button>
          <button class="small" style="background:transparent;border:0;color:var(--muted);cursor:pointer" onclick="cartIncrease(${idx})">+</button>
          <button class="small" style="background:#dc2626;color:#fff;border-radius:6px;padding:4px 8px;border:0;cursor:pointer" onclick="cartRemove(${idx})">Ø­Ø°Ù</button>
        </div>
      </div>`;
    cartItemsEl.appendChild(line);
  });
  // apply offer discount display
  const offerId = applyOfferSelect.value;
  let final = total;
  if(offerId){
    const of = offers.find(o=>o.id===offerId);
    if(of){ final = Math.round(total * (1 - of.discount/100)); }
  }
  cartTotalEl.textContent = `${final} Ø¬`;
}

function cartRemove(idx){ cart.splice(idx,1); updateCartDisplay(); saveState(); }
function cartIncrease(idx){ cart[idx].qty++; updateCartDisplay(); }
function cartDecrease(idx){ if(cart[idx].qty>1){ cart[idx].qty--; } else cart.splice(idx,1); updateCartDisplay(); saveState(); }
document.getElementById('clearCartBtn').addEventListener('click', ()=>{ cart=[]; updateCartDisplay(); notify('ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©','info'); });

// --- Checkout flow ---
function openCheckout(){
  if(cart.length===0){ notify('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©','warning'); return; }
  // prefill with saved customer if exists
  if(currentCustomer){
    orderName.value = currentCustomer.name || '';
    orderPhone.value = currentCustomer.phone || '';
  }
  checkoutSection.style.display='block';
  checkoutSection.scrollIntoView({behavior:'smooth'});
}

function confirmOrder(){
  const name = orderName.value.trim();
  const phone = orderPhone.value.trim();
  const address = orderAddress.value.trim();
  const payment = orderPayment.value;
  const notes = orderNotes.value.trim();
  const offerId = applyOfferSelect.value;
  if(!name||!phone||!address){ notify('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨','warning'); return; }
  // prepare order
  const orderId = 'ORD-' + ( ++orderCounter );
  localStorage.setItem(LS_KEYS.ORDER_COUNTER, String(orderCounter));
  const totalBefore = cart.reduce((s,c)=>s + c.price*c.qty,0);
  let total = totalBefore;
  let appliedOffer = null;
  if(offerId){
    const o = offers.find(x=>x.id===offerId);
    if(o){ appliedOffer = {id:o.id,name:o.name,discount:o.discount}; total = Math.round(total*(1 - o.discount/100)); }
  }

  const newOrder = {
    id:orderId,
    customer:{name,phone,address},
    items: cart.map(c=>({id:c.id,name:c.name,price:c.price,qty:c.qty})),
    totalBefore, total, payment, notes, status:'received', createdAt:new Date().toLocaleString('ar-EG'), date: new Date().toDateString(), appliedOffer
  };

  // increment sold counters in menu
  newOrder.items.forEach(it=>{
    const mItem = findItemById(it.id);
    if(mItem){ mItem.sold = (mItem.sold||0) + it.qty; }
  });

  orders.unshift(newOrder);
  saveState();
  cart = [];
  updateCartDisplay();
  checkoutSection.style.display='none';
  notify(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ${orderId}`,'success');
  // update operator view
  renderOrders();
  updateReports();
  // show detailed message area for operator
  if(mainOperator.style.display !== 'none' && operatorDashboard.style.display !== 'none'){
    renderOrders();
  }
}

// --- Operator ---
function operatorLogin(){
  const val = operatorPasswordInput.value;
  if(val === operatorPassword){
    operatorLoginPanel.style.display='none';
    operatorDashboard.style.display='block';
    operatorHint.textContent = 'Ù…Ø´ØºÙ„ Ù…Ø¤Ù…Ù†';
    notify('Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´ØºÙ„ Ù†Ø§Ø¬Ø­','success');
    renderOrders();
    renderManageMenu();
    renderOffers();
    updateReports();
  } else {
    notify('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©','error');
  }
}

function operatorLogout(){
  operatorLoginPanel.style.display='block';
  operatorDashboard.style.display='none';
  operatorHint.textContent = 'Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬';
  notify('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬','info');
}

function saveOperatorPassword(){
  const v = document.getElementById('newOperatorPassword').value.trim();
  if(!v) { notify('Ø§Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©','warning'); return; }
  operatorPassword = v;
  localStorage.setItem(LS_KEYS.OP_PWD, operatorPassword);
  document.getElementById('newOperatorPassword').value='';
  notify('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±','success');
}

document.getElementById('saveOperatorPwd').addEventListener('click', saveOperatorPassword);

// --- Render orders for operator ---
function renderOrders(){
  ordersGrid.innerHTML = '';
  if(orders.length===0){ ordersGrid.innerHTML='<div class="small" style="text-align:center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>'; return; }
  orders.forEach(o=>{
    const card = document.createElement('div');
    card.className = 'order-card';
    const statusClass = {received:'status-new',preparing:'status-preparing',ready:'status-ready',delivered:'status-delivered'}[o.status] || '';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Ø·Ù„Ø¨ Ø±Ù‚Ù…: ${o.id}</strong><div class="small">${o.createdAt}</div></div>
        <div><span class="badge">${o.status}</span></div>
      </div>
      <div style="margin-top:8px">
        <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${o.customer.name} â€” <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> ${o.customer.phone}</div>
        <div class="small">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${o.customer.address}</div>
        <div class="small">Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©: ${o.payment}</div>
        ${o.notes ? `<div class="small">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${o.notes}</div>` : ''}
      </div>
      <div style="margin-top:10px;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px">
        ${o.items.map(i=>`<div style="display:flex;justify-content:space-between"><div>${i.name} Ã— ${i.qty}</div><div>${i.price*i.qty} Ø¬</div></div>`).join('')}
        <div style="margin-top:8px;font-weight:bold">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${o.total} Ø¬</div>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        ${o.status==='received' ? `<button class="btn" onclick="changeOrderStatus('${o.id}','preparing')">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</button>` : '' }
        ${o.status==='preparing' ? `<button class="btn" onclick="changeOrderStatus('${o.id}','ready')">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ³Ù„ÙŠÙ…</button>` : '' }
        ${o.status==='ready' ? `<button class="btn secondary" onclick="changeOrderStatus('${o.id}','delivered')">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</button>` : '' }
        <button class="btn secondary" onclick="printOrder('${o.id}')">Ø·Ø¨Ø§Ø¹Ø©/ØªÙØ§ØµÙŠÙ„</button>
      </div>
    `;
    ordersGrid.appendChild(card);
  });
}

function changeOrderStatus(orderId, newStatus){
  const ord = orders.find(o=>o.id===orderId);
  if(!ord) return;
  ord.status = newStatus;
  saveState();
  renderOrders();
  updateReports();
  notify(`ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© ${orderId} Ø¥Ù„Ù‰ ${newStatus}`,'success');
}

function printOrder(orderId){
  const ord = orders.find(o=>o.id===orderId);
  if(!ord) return;
  const win = window.open('','_blank');
  win.document.write(`<pre>${JSON.stringify(ord,null,2)}</pre>`);
}

// --- Manage menu in operator ---
function renderManageMenu(){
  manageMenuList.innerHTML = '';
  Object.keys(menu).forEach(cat => {
    const box = document.createElement('div');
    box.className = 'card small';
    box.style.padding = '8px';
    let html = `<strong>${cat}</strong><div class="small" style="margin-top:6px">`;
    menu[cat].forEach(it=>{
      html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px;background:rgba(0,0,0,0.03);border-radius:6px;margin-top:6px">
        <div style="flex:1"><div><strong>${it.name}</strong></div><div class="small">${it.sold||0} Ù…Ø¨ÙŠØ¹</div></div>
        <div style="display:flex;gap:6px;align-items:center">
          <input class="input small" type="number" value="${it.price}" style="width:80px" id="price_${it.id}" />
          <button class="btn" onclick="applyPriceChange('${cat}','${it.id}')">Ø­ÙØ¸</button>
          <button class="btn secondary" onclick="toggleAvailability('${cat}','${it.id}')">${it.available? 'Ø¥ÙŠÙ‚Ø§Ù' : 'ØªÙØ¹ÙŠÙ„'}</button>
          <button class="btn secondary" onclick="removeMenuItem('${cat}','${it.id}')">Ø­Ø°Ù</button>
        </div>
      </div>`;
    });
    html += `</div>`;
    box.innerHTML = html;
    manageMenuList.appendChild(box);
  });
}

function applyPriceChange(cat,id){
  const el = document.getElementById('price_'+id);
  if(!el) return;
  const v = Number(el.value);
  if(isNaN(v)||v<0){ notify('Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­','warning'); return; }
  const it = menu[cat].find(x=>x.id===id);
  if(it){ it.price = v; saveState(); renderMenu(); renderManageMenu(); notify('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø±','success'); }
}

function toggleAvailability(cat,id){
  const it = menu[cat].find(x=>x.id===id);
  if(it){ it.available = !it.available; saveState(); renderMenu(); renderManageMenu(); notify(it.available? 'ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„':'ØªÙ… Ø§Ù„Ø§ÙŠÙ‚Ø§Ù','info'); }
}

function removeMenuItem(cat,id){
  if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ')) return;
  menu[cat] = menu[cat].filter(x=>x.id!==id);
  saveState();
  renderMenu();
  renderManageMenu();
  notify('ØªÙ… Ø§Ù„Ø­Ø°Ù','info');
}

function addMenuItemFromForm(){
  const name = newName.value.trim();
  const price = Number(newPrice.value);
  const cat = newCategory.value;
  if(!name||isNaN(price)||price<0){ notify('Ø§Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©','warning'); return; }
  const id = generateId('m');
  if(!menu[cat]) menu[cat]=[];
  menu[cat].push({id,name,price,available:true,sold:0});
  saveState();
  newName.value=''; newPrice.value='';
  renderMenu(); renderManageMenu();
  notify('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù','success');
}

// --- Offers ---
function renderApplyOffers(){
  applyOfferSelect.innerHTML = '<option value="">Ù„Ø§ ÙŠÙˆØ¬Ø¯</option>';
  offers.forEach(o=>{
    const opt = document.createElement('option');
    opt.value = o.id; opt.textContent = `${o.name} â€” ${o.discount}%`;
    applyOfferSelect.appendChild(opt);
  });
}

function renderOffers(){
  activeOffersList.innerHTML = '';
  if(offers.length===0){ activeOffersList.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶</div>'; return; }
  offers.forEach(o=>{
    const d = document.createElement('div');
    d.className = 'card small';
    d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${o.name}</strong><div class="small">Ø®ØµÙ… ${o.discount}%</div></div>
      <div><button class="btn secondary" onclick="removeOffer('${o.id}')">Ø¥Ù„ØºØ§Ø¡</button></div>
    </div>`;
    activeOffersList.appendChild(d);
  });
  renderApplyOffers();
}

function createOffer(){
  const name = offerName.value.trim();
  const discount = Number(offerDiscount.value);
  if(!name || isNaN(discount) || discount<0 || discount>100){ notify('Ø§Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©','warning'); return; }
  const id = generateId('offer');
  offers.push({id,name,discount,created:new Date().toLocaleDateString('ar-EG')});
  saveState();
  offerName.value=''; offerDiscount.value='';
  renderOffers();
  notify('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø¶','success');
}

function removeOffer(id){
  offers = offers.filter(o=>o.id!==id);
  saveState(); renderOffers(); notify('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶','info');
}

// --- Helpers ---
function findItemById(id){
  for(const cat of Object.keys(menu)){
    const found = menu[cat].find(i=>i.id===id);
    if(found) return found;
  }
  return null;
}

function populateCategorySelect(){
  newCategory.innerHTML = '';
  Object.keys(menu).forEach(k=>{
    const opt = document.createElement('option'); opt.value = k; opt.textContent = k;
    newCategory.appendChild(opt);
  });
}

function saveState(){
  saveLS(LS_KEYS.MENU, menu);
  saveLS(LS_KEYS.ORDERS, orders);
  saveLS(LS_KEYS.OFFERS, offers);
  localStorage.setItem(LS_KEYS.OP_PWD, operatorPassword);
  localStorage.setItem(LS_KEYS.ORDER_COUNTER, String(orderCounter));
  // reflect current customer
  if(currentCustomer) saveLS(LS_KEYS.CUST,currentCustomer);
}

function exportAllData(){
  const data = {menu,orders,offers,operatorPassword};
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='talabat_koshary_export.json'; a.click(); URL.revokeObjectURL(url);
  notify('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','success');
}

// --- Reports ---
function updateReports(){
  const today = new Date().toDateString();
  const todayOrders = orders.filter(o=>o.date === today);
  const rev = todayOrders.reduce((s,o)=>s + (o.total||0),0);
  rToday.textContent = todayOrders.length;
  rRevenue.textContent = rev;
  rTotal.textContent = orders.length;
  // popularity
  const counts = {};
  orders.forEach(o=> o.items.forEach(it=> counts[it.name] = (counts[it.name]||0)+it.qty));
  const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  rTop.textContent = sorted.length? sorted[0][0] : '-';
  popularList.innerHTML = '';
  sorted.slice(0,6).forEach(([name,c],i)=>{
    const d = document.createElement('div'); d.className='card small'; d.style.marginBottom='8px';
    d.innerHTML = `<div style="display:flex;justify-content:space-between"><div>${i+1}. ${name}</div><div class="badge">${c} Ø·Ù„Ø¨</div></div>`;
    popularList.appendChild(d);
  });
}

// --- Notifications ---
function notify(msg,type='success'){ const el = document.getElementById('notify'); el.style.display='block'; el.style.background = (type==='success'?'#16a34a': type==='error' ? '#dc2626' : type==='warning' ? '#f59e0b' : '#0ea5a4'); el.textContent = msg; setTimeout(()=>el.style.display='none',3000); }

// --- Utility to load saved saved and render UI ---
function renderManageMenu(){ renderManageMenu; } // placeholder to avoid linter hint, actual renderManageMenu defined earlier

// --- Misc actions triggered by inline buttons ---
window.changeOrderStatus = changeOrderStatus;
window.printOrder = printOrder;
window.applyPriceChange = applyPriceChange;
window.toggleAvailability = toggleAvailability;
window.removeMenuItem = removeMenuItem;
window.removeOffer = removeOffer;
window.cartRemove = cartRemove;
window.cartIncrease = cartIncrease;
window.cartDecrease = cartDecrease;

// --- Save customer ---
function saveCustomer(){
  const n = custNameInput.value.trim();
  const p = custPhoneInput.value.trim();
  if(!n || !p){ notify('Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„','warning'); return; }
  currentCustomer = {name:n, phone:p};
  saveState();
  cartCustomerInfo.textContent = `${n} â€” ${p}`;
  notify('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ','success');
}

// --- find order by id helper ---
function findOrderById(id){ return orders.find(o=>o.id===id); }

// --- Initialization call ---
init();

// attach some missing handlers set earlier
document.getElementById('checkoutBtn').addEventListener('click', openCheckout);
document.getElementById('confirmOrderBtn').addEventListener('click', confirmOrder);
document.getElementById('cancelCheckoutBtn').addEventListener('click', ()=>checkoutSection.style.display='none');
document.getElementById('operatorLoginBtn').addEventListener('click', operatorLogin);
document.getElementById('exportDataBtn').addEventListener('click', exportAllData);
document.getElementById('addNewItemBtn').addEventListener('click', addMenuItemFromForm);
document.getElementById('createOfferBtn').addEventListener('click', createOffer);
document.getElementById('saveOperatorPwd').addEventListener('click', saveOperatorPassword);

</script>
</body>
</html>
